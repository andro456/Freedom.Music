<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>freedom.music</title>
  <style>
    /* --- 1. RESET & VARIABLES --- */
    :root { --primary: #e50914; --bg: #000; --panel: #121212; --text-sub: #b3b3b3; --accent: #1db954; }
    * { box-sizing: border-box; }
    body { 
      margin: 0; background-color: var(--bg); color: white; 
      font-family: 'Circular', 'Segoe UI', sans-serif; 
      height: 100vh; display: grid; 
      grid-template-columns: 220px 1fr 350px; 
      grid-template-rows: 1fr 90px; 
      overflow: hidden; user-select: none; 
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    
    /* SIDEBAR */
    .sidebar { grid-column: 1; grid-row: 1; background: var(--bg); padding: 20px 12px; display: flex; flex-direction: column; z-index: 20; }
    .logo { color: var(--primary); font-size: 22px; font-weight: 800; margin-bottom: 30px; padding-left: 10px; display: flex; align-items: center; letter-spacing: -0.5px; }
    .nav-btn { color: var(--text-sub); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 6px; transition: 0.2s; font-size: 14px; margin-bottom: 5px; }
    .nav-btn:hover, .nav-btn.active { color: white; background-color: #282828; }
    .nav-btn svg { width: 22px; height: 22px; stroke-width: 2px; }
    .playlist-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 10px 5px; color: var(--text-sub); font-size: 11px; font-weight: bold; letter-spacing: 1px; }
    .playlist-add-btn { background: none; border: none; color: var(--text-sub); cursor: pointer; font-size: 18px; }
    .playlist-add-btn:hover { color: white; }
    .playlist-item { color: var(--text-sub); padding: 8px 10px; cursor: pointer; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .playlist-item:hover { color: white; }

    /* MAIN VIEW */
    .main-view { grid-column: 2; grid-row: 1; background: linear-gradient(180deg, #1a1a1a 0%, #121212 100%); border-radius: 8px; margin: 8px 0; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
    .top-bar { position: sticky; top: 0; background: rgba(18, 18, 18, 0.96); padding: 16px 30px; z-index: 30; display: flex; align-items: center; gap: 15px; }
    .search-box { background: #2a2a2a; border: none; border-radius: 50px; padding: 12px 20px; color: white; width: 100%; max-width: 400px; font-size: 14px; outline: none; transition: 0.2s; }
    .search-box:focus { background: #333; box-shadow: 0 0 0 2px var(--primary); }

    /* HOME */
    .home-section { padding: 20px 30px; }
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 15px; color: white; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; }
    .card { background: #181818; padding: 15px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
    .card:hover { background: #282828; }
    .card-img, .collection-cover { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); overflow: hidden; position: relative; }
    .cover-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 100%; height: 100%; }
    .cover-grid img { width: 100%; height: 100%; object-fit: cover; }
    .card-title { font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .card-desc { font-size: 12px; color: var(--text-sub); }

    /* SONG LIST */
    .song-list { padding: 10px 30px; flex: 1; display: none; padding-bottom: 50px; }
    .song-row { display: flex; align-items: center; padding: 10px; border-radius: 4px; cursor: pointer; transition: 0.2s; position: relative; z-index: 1; }
    .song-row:hover { background-color: rgba(255,255,255,0.1); }
    .song-row:hover .menu-btn, .song-row:hover .row-like-btn { opacity: 1; }
    .song-img { width: 45px; height: 45px; border-radius: 4px; object-fit: cover; margin-right: 15px; }
    .song-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .song-title { color: white; font-size: 15px; font-weight: 500; display:flex; align-items:center; gap:8px;}
    .song-artist { color: var(--text-sub); font-size: 13px; }
    
    /* TICK ICON IN LIST */
    .tick-icon { color: var(--accent); font-size: 14px; display: none; margin-left: 5px; }
    .song-row.downloaded .tick-icon { display: block; }

    /* BUTTONS */
    .row-actions { display: flex; align-items: center; gap: 5px; }
    .menu-btn, .row-like-btn { background: transparent; border: none; color: var(--text-sub); width: 32px; height: 32px; border-radius: 50%; opacity: 0; cursor: pointer; z-index: 50; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .menu-btn:hover, .row-like-btn:hover { color: white; opacity: 1; background: rgba(255,255,255,0.1); }
    .row-like-btn.liked { color: var(--primary); opacity: 1; }

    /* PLAYLIST HEADER */
    .collection-header { padding: 30px; display: none; align-items: flex-end; gap: 20px; background: linear-gradient(transparent, rgba(0,0,0,0.5)); }
    .collection-cover { width: 180px; height: 180px; min-width: 180px; background: #333; display: flex; align-items: center; justify-content: center; font-size: 60px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
    .collection-info h1 { font-size: 50px; font-weight: 800; margin: 10px 0; }
    .header-actions { display: flex; align-items: center; gap: 20px; margin-top: 20px; }
    
    .big-play-btn { width: 56px; height: 56px; border-radius: 50%; background: var(--primary); border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .big-play-btn:hover { transform: scale(1.05); }
    .big-play-btn svg { fill: black; width: 28px; height: 28px; margin-left: 4px; }

    .action-btn { background: transparent; border: none; color: #b3b3b3; cursor: pointer; transition: 0.2s; position: relative; display:flex; align-items:center; gap:8px;}
    .action-btn:hover { color: white; transform: scale(1.05); }
    .action-btn svg { width: 32px; height: 32px; }
    
    /* ANIMATION */
    .action-btn.downloading { color: var(--accent); pointer-events: none; animation: pulse 1.5s infinite; }
    .action-btn.downloading svg { display: none; }
    .action-btn.downloading::after { content: attr(data-status); font-size: 14px; font-weight: bold; white-space:nowrap; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* COMPLETED DOWNLOAD STATE */
    .action-btn.done { color: var(--accent); cursor: default; }
    .action-btn.done:hover { transform: none; }

    /* LAYOUTS */
    .lyrics-panel { grid-column: 3; grid-row: 1; background-color: #000; padding: 24px; overflow-y: auto; border-left: 1px solid #222; display: none; }
    .lyrics-panel.show { display: block; }
    .lyrics-text { color: #ccc; font-size: 18px; line-height: 1.6; white-space: pre-wrap; font-weight: 600; }

    .player-bar { grid-column: 1 / span 3; grid-row: 2; background-color: #000; border-top: 1px solid #222; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; }
    .now-playing { display: flex; align-items: center; width: 30%; }
    .np-img { width: 56px; height: 56px; border-radius: 4px; margin-right: 15px; display: none; }
    .np-title { color: white; font-size: 14px; font-weight: 600; }
    .np-artist { color: var(--text-sub); font-size: 12px; }
    .controls { display: flex; flex-direction: column; align-items: center; width: 40%; }
    .buttons { display: flex; align-items: center; gap: 20px; margin-bottom: 8px; }
    .btn-icon { background: none; border: none; cursor: pointer; color: var(--text-sub); transition: 0.2s; display: flex; align-items: center; }
    .btn-icon:hover { color: white; }
    .btn-icon.active { color: var(--primary); position: relative; }
    .btn-play { width: 35px; height: 35px; border-radius: 50%; background: white; color: black; display: flex; align-items: center; justify-content: center; cursor: pointer; transition:0.2s; border: none; }
    .btn-play:hover { transform: scale(1.05); }
    .spinner { width: 18px; height: 18px; border: 3px solid #ccc; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .btn-play.loading svg { display: none; }
    .btn-play.loading .spinner { display: block; }
    .btn-play.loading { background: #333; cursor: wait; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress-container { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 11px; color: var(--text-sub); }
    .progress-wrapper { flex: 1; height: 4px; background: #333; border-radius: 2px; cursor: pointer; position: relative; }
    .progress-fill { width: 0%; height: 100%; background: white; border-radius: 2px; }
    .actions { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
    .lyrics-btn { font-size: 10px; font-weight: 800; letter-spacing: 1px; color: var(--text-sub); border: 2px solid var(--text-sub); padding: 4px 8px; border-radius: 4px; background: transparent; cursor: pointer; }
    .lyrics-btn:hover, .lyrics-btn.active { color: white; border-color: white; }
    .lyrics-btn.active { background: #333; }

    .context-menu { position: fixed; background: #222; border-radius: 4px; padding: 5px; box-shadow: 0 4px 15px black; display: none; z-index: 10000; min-width: 160px; }
    .ctx-item { padding: 10px 15px; color: #eee; font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; }
    .ctx-item:hover { background: #333; }
    .ctx-delete { color: #ff4444; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
    .modal { background: #222; padding: 25px; border-radius: 8px; width: 300px; text-align: center; }
    .modal input { width: 100%; padding: 10px; margin: 15px 0; background: #111; border: 1px solid #333; color: white; border-radius: 4px; }
    .modal-btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }
    .modal-btn.primary { background: var(--primary); color: white; }
    .modal-btn.cancel { background: transparent; color: white; }
    audio { display: none; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="logo">freedom.music</div>
    <div class="nav-btn active" id="btn-home" onclick="showHome()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> Home
    </div>
    <div class="nav-btn" onclick="showSearch()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Search
    </div>
    <div class="playlist-header">
        <span>YOUR LIBRARY</span>
        <button class="playlist-add-btn" onclick="openModal()">+</button>
    </div>
    <div id="playlist-list"></div>
  </div>

  <div class="main-view">
    <div class="top-bar">
      <input id="search-input" class="search-box" placeholder="Search songs, artists...">
    </div>

    <div id="view-home">
        <div class="home-section" id="sec-recent">
            <div class="section-title">Recently Played</div>
            <div class="card-grid" id="grid-recent"></div>
        </div>
        <div class="home-section">
            <div class="section-title">Your Playlists</div>
            <div class="card-grid" id="grid-playlists"></div>
        </div>
    </div>

    <div class="collection-header" id="view-header">
        <div class="collection-cover" id="pl-cover">P</div>
        <div class="collection-info">
            <p style="font-size:12px; font-weight:bold;">PLAYLIST</p>
            <h1 id="pl-title">Title</h1>
            <p id="pl-desc" style="color:#ccc; font-size:14px;">0 songs</p>
            
            <div class="header-actions">
                <button class="big-play-btn" onclick="playCurrentQueue()">
                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                
                <button class="action-btn" title="Download All" onclick="downloadPlaylist()" id="btn-download" data-status="Downloading...">
                    <svg class="icon-dl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <svg class="icon-tick" style="display:none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </button>

                <button class="action-btn" title="Delete Playlist" onclick="deletePlaylist()" id="btn-delete-pl">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div class="song-list" id="view-list"></div>
  </div>

  <div class="lyrics-panel" id="lyrics-panel">
    <div style="font-size:20px; font-weight:bold; margin-bottom:20px;">Lyrics</div>
    <div class="lyrics-text" id="lyrics-content"></div>
  </div>

  <div class="player-bar">
    <div class="now-playing">
      <img id="np-img" class="np-img" src="">
      <div class="np-info">
        <div id="np-title" class="np-title"></div>
        <div id="np-artist" class="np-artist"></div>
      </div>
    </div>

    <div class="controls">
      <div class="buttons">
        <button class="btn-icon" id="btn-shuffle" onclick="toggleShuffle()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5"/></svg>
        </button>
        <button class="btn-icon" onclick="playPrev()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        </button>
        <button class="btn-play" id="btn-play" onclick="togglePlay()">
            <div class="spinner"></div>
            <svg width="18" height="18" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <button class="btn-icon" onclick="playNext()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
        </button>
        <button class="btn-icon" id="btn-loop" onclick="toggleLoop()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
        </button>
      </div>
      <div class="progress-container">
        <span id="t-curr">0:00</span>
        <div class="progress-wrapper" id="p-wrap" onclick="seek(event)"><div class="progress-fill" id="p-fill"></div></div>
        <span id="t-total">0:00</span>
      </div>
    </div>

    <div class="actions">
      <button class="lyrics-btn" id="btn-lyrics" onclick="toggleLyrics()">LYRICS</button>
    </div>
  </div>

  <audio id="audio"></audio>

  <div class="modal-overlay" id="modal">
      <div class="modal">
          <h3>Create Playlist</h3>
          <input id="pl-input" placeholder="Playlist Name">
          <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
          <button class="modal-btn primary" onclick="createPlaylist()">Create</button>
      </div>
  </div>

  <div class="context-menu" id="ctx-menu">
      <div class="ctx-item" id="ctx-remove" onclick="removeFromPlaylist()">
          <span class="ctx-delete">Remove from this Playlist</span>
      </div>
      <div style="height:1px; background:#444; margin:5px 0;"></div>
      <div style="font-size:10px; color:#888; padding:0 15px;">ADD TO PLAYLIST</div>
      <div id="ctx-playlists"></div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const audio = document.getElementById('audio');
    
    let library = { likedSongs: [], playlists: [], history: [] };
    let downloadedFiles = []; 
    let queue = [], originalQueue = [], currentIndex = -1;
    let isShuffle = false, loopMode = 0;
    let selectedSong = null;
    let currentPlaylistName = null;

    function decodeHtml(html) {
        const txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
    }

    // --- REFRESH LOGIC ---
    async function refreshLibrary() {
        library = await ipcRenderer.invoke('get-library');
        downloadedFiles = await ipcRenderer.invoke('get-downloaded-files');
        renderSidebar();
    }

    async function init() {
        await refreshLibrary();
        showHome();
    }
    init();

    // --- HELPER: EXACT FILENAME CHECK ---
    function isSongDownloaded(title, videoId) {
        const safeTitle = decodeHtml(title).replace(/[^a-z0-9]/gi, '_');
        const filename = `${safeTitle}_${videoId}.m4a`;
        return downloadedFiles.includes(filename);
    }

    // --- NAVIGATION ---
    function hideAll() {
        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-header').style.display = 'none';
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('btn-home').classList.remove('active');
        currentPlaylistName = null;
    }

    function showHome() {
        hideAll();
        document.getElementById('view-home').style.display = 'block';
        document.getElementById('btn-home').classList.add('active');
        
        const gridRecent = document.getElementById('grid-recent');
        gridRecent.innerHTML = '';
        if(library.history.length === 0) document.getElementById('sec-recent').style.display = 'none';
        else {
            document.getElementById('sec-recent').style.display = 'block';
            library.history.slice(0, 6).forEach(song => {
                const card = createCard(decodeHtml(song.title), decodeHtml(song.artist), song.img, () => playImmediate(song));
                gridRecent.appendChild(card);
            });
        }

        const gridPl = document.getElementById('grid-playlists');
        gridPl.innerHTML = '';
        const likedCard = createCard("Liked Songs", `${library.likedSongs.length} songs`, null, () => showPlaylist('Liked Songs'));
        generateCoverForCard(likedCard.querySelector('.card-img'), library.likedSongs);
        gridPl.appendChild(likedCard);

        library.playlists.forEach(pl => {
            const card = createCard(decodeHtml(pl.name), `${pl.songs.length} songs`, null, () => showPlaylist(pl.name));
            generateCoverForCard(card.querySelector('.card-img'), pl.songs);
            gridPl.appendChild(card);
        });
    }

    function createCard(title, subtitle, img, onClick) {
        const div = document.createElement('div');
        div.className = 'card'; div.onclick = onClick;
        div.innerHTML = `
            <div class="card-img" style="background:#333; display:flex; align-items:center; justify-content:center; color:#555; font-size:30px; font-weight:bold;">${title[0]}</div>
            <div class="card-title">${title}</div>
            <div class="card-desc">${subtitle}</div>
        `;
        if(img) div.querySelector('.card-img').innerHTML = `<img src="${img}" style="width:100%; height:100%; object-fit:cover;">`;
        return div;
    }

    function generateCoverForCard(element, songs) {
        element.innerHTML = '';
        if(songs.length === 0) {
            element.innerText = "♫"; element.style.color = "#555"; return;
        }
        if(songs.length < 4) {
            element.innerHTML = `<img src="${songs[0].img}" style="width:100%; height:100%; object-fit:cover;">`;
        } else {
            element.innerHTML = `<div class="cover-grid">
                <img src="${songs[0].img}"><img src="${songs[1].img}">
                <img src="${songs[2].img}"><img src="${songs[3].img}">
            </div>`;
        }
    }

    function showSearch() {
        hideAll();
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('search-input').focus();
    }

    async function showPlaylist(name) {
        hideAll();
        currentPlaylistName = name;
        document.getElementById('view-header').style.display = 'flex';
        document.getElementById('view-list').style.display = 'block';
        
        document.getElementById('btn-delete-pl').style.display = (name === 'Liked Songs') ? 'none' : 'block';

        let songs = (name === 'Liked Songs') ? library.likedSongs : library.playlists.find(p => p.name === name).songs;
        
        document.getElementById('pl-title').innerText = decodeHtml(name);
        document.getElementById('pl-desc').innerText = songs.length + " songs";
        generateCoverForCard(document.getElementById('pl-cover'), songs);
        
        // CHECK ALL DOWNLOADED FOR BUTTON STATE
        const isAllDownloaded = songs.length > 0 && songs.every(s => isSongDownloaded(s.title, s.id));
        const btnDl = document.getElementById('btn-download');
        
        // RESET BUTTON STATE FIRST
        btnDl.classList.remove('downloading', 'done');
        btnDl.querySelector('.icon-dl').style.display = 'block';
        btnDl.querySelector('.icon-tick').style.display = 'none';
        btnDl.onclick = downloadPlaylist;
        btnDl.title = "Download All";

        if(isAllDownloaded) {
            btnDl.classList.add('done');
            btnDl.querySelector('.icon-dl').style.display = 'none';
            btnDl.querySelector('.icon-tick').style.display = 'block';
            btnDl.onclick = null;
            btnDl.title = "Downloaded";
        }

        renderList(songs, true);
        queue = [...songs]; originalQueue = [...songs];
    }

    document.getElementById('search-input').addEventListener('keypress', async (e) => {
        if(e.key === 'Enter') {
            showSearch();
            const res = await ipcRenderer.invoke('yt-search', e.target.value);
            if(res.success) renderList(res.data, false);
        }
    });

    // --- RENDER LIST ---
    function renderList(songs, isContextPlaylist) {
        const list = document.getElementById('view-list');
        list.innerHTML = '';
        songs.forEach((song, idx) => {
            const div = document.createElement('div');
            
            const isDownloaded = isSongDownloaded(song.title, song.id);
            const isLiked = library.likedSongs.some(s => s.id === song.id);

            div.className = isDownloaded ? 'song-row downloaded' : 'song-row';
            
            div.innerHTML = `
                <img class="song-img" src="${song.img}">
                <div class="song-info">
                    <div class="song-title">
                        ${decodeHtml(song.title)}
                        <span class="tick-icon">✔</span>
                    </div>
                    <div class="song-artist">${decodeHtml(song.artist)}</div>
                </div>
                <div class="row-actions">
                    <button class="row-like-btn ${isLiked?'liked':''}">${isLiked?'❤️':'♡'}</button>
                    <button class="menu-btn">⋮</button>
                </div>
            `;
            
            div.onclick = (e) => {
                if(e.target.className.includes('menu-btn') || e.target.className.includes('row-like-btn')) return;
                if(isContextPlaylist) { currentIndex = idx; playSong(queue[currentIndex]); }
                else playImmediate(song);
            };

            div.querySelector('.row-like-btn').onclick = (e) => { e.stopPropagation(); toggleLikeRow(song, e.target); };
            div.querySelector('.menu-btn').onclick = (e) => { e.stopPropagation(); openMenu(e, song); };

            list.appendChild(div);
        });
    }

    function playImmediate(song) {
        queue = [song]; originalQueue = [song]; currentIndex = 0; 
        isShuffle = false; loopMode = 0; updateIcons();
        playSong(song);
    }

    async function playSong(song) {
        document.getElementById('np-img').src = song.img;
        document.getElementById('np-img').style.display = 'block';
        document.getElementById('np-title').innerText = decodeHtml(song.title);
        document.getElementById('np-artist').innerText = decodeHtml(song.artist);
        
        const pBtn = document.getElementById('btn-play');
        pBtn.classList.add('loading');
        
        ipcRenderer.invoke('add-to-history', song).then(() => {
             refreshLibrary();
        });

        // 1. CHECK OFFLINE
        const offlineCheck = await ipcRenderer.invoke('check-offline', { videoId: song.id, title: decodeHtml(song.title) });
        
        if (offlineCheck.success) {
            console.log("PLAYING OFFLINE");
            audio.src = "file://" + offlineCheck.url.replace(/\\/g, "/"); 
            audio.play();
            updatePlayBtn(true);
            pBtn.classList.remove('loading');
        } else {
            console.log("STREAMING");
            const res = await ipcRenderer.invoke('yt-stream', song.id);
            if(res.success) { audio.src = res.url; audio.play(); updatePlayBtn(true); }
            else { pBtn.classList.remove('loading'); }
        }

        document.getElementById('lyrics-content').innerText = "Loading...";
        const titleClean = song.title.replace(/\([^)]*\)|\[[^\]]*\]|Official Video|ft\.|feat\./gi, "").trim();
        ipcRenderer.invoke('get-lyrics', { title: titleClean, artist: song.artist }).then(res => {
            document.getElementById('lyrics-content').innerText = res.success ? res.lyrics.replace(/\[\d{2}:\d{2}\.\d{2,3}\]/g, "") : "Lyrics not found.";
        });
    }

    audio.onplaying = () => { document.getElementById('btn-play').classList.remove('loading'); updatePlayBtn(true); };
    audio.onpause = () => updatePlayBtn(false);

    function togglePlay() { if(audio.paused) { audio.play(); } else { audio.pause(); } }
    function updatePlayBtn(is) {
        const pBtn = document.getElementById('btn-play');
        if(pBtn.classList.contains('loading')) return;
        pBtn.innerHTML = is ? `<svg width="16" height="16" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>` : `<svg width="18" height="18" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
    }
    
    function toggleLikeRow(song, btn) {
        ipcRenderer.invoke('add-to-playlist', { playlistName: 'Liked Songs', song: song })
        .then(async () => { 
            await refreshLibrary();
            const isLiked = library.likedSongs.some(s => s.id === song.id);
            btn.innerText = isLiked ? "❤️" : "♡";
            btn.classList.toggle('liked', isLiked);
        });
    }

    async function downloadPlaylist() {
        if(!queue.length) return;
        const btn = document.getElementById('btn-download');
        btn.classList.add('downloading');
        btn.setAttribute('data-status', 'Downloading...');
        
        let count = 0;
        for (const song of queue) {
            count++;
            if(!isSongDownloaded(song.title, song.id)) {
                btn.setAttribute('data-status', `Downloading ${count}/${queue.length}...`);
                await ipcRenderer.invoke('yt-download', {
                    videoId: song.id, 
                    title: decodeHtml(song.title),
                    artist: song.artist,
                    img: song.img
                });
            }
        }
        
        // REFRESH FULL STATE
        await refreshLibrary();
        showPlaylist(currentPlaylistName); // This triggers the tick check
    }

    function playCurrentQueue() { if(queue.length) { currentIndex=0; playSong(queue[0]); } }
    function playNext() { 
        if(!queue.length) return;
        if(currentIndex < queue.length - 1) { currentIndex++; playSong(queue[currentIndex]); }
        else if(loopMode === 1) { currentIndex = 0; playSong(queue[0]); }
    }
    function playPrev() {
        if(audio.currentTime > 3) { audio.currentTime = 0; return; }
        if(currentIndex > 0) { currentIndex--; playSong(queue[currentIndex]); }
    }
    audio.onended = () => loopMode === 2 ? (audio.currentTime=0, audio.play()) : playNext();

    function toggleShuffle() {
        isShuffle = !isShuffle;
        if(isShuffle) {
            const curr = queue[currentIndex];
            let rem = queue.filter((_, i) => i !== currentIndex);
            for(let i=rem.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [rem[i], rem[j]]=[rem[j], rem[i]]; }
            queue = [curr, ...rem]; currentIndex = 0;
        } else {
            const id = queue[currentIndex].id;
            queue = [...originalQueue];
            currentIndex = queue.findIndex(s => s.id === id);
        }
        updateIcons();
    }
    function toggleLoop() { loopMode = (loopMode + 1) % 3; updateIcons(); }
    function updateIcons() {
        document.getElementById('btn-shuffle').classList.toggle('active', isShuffle);
        const lBtn = document.getElementById('btn-loop');
        lBtn.classList.toggle('active', loopMode > 0);
        if(loopMode === 2) lBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/><text x="10" y="15" font-size="8" fill="currentColor" stroke="none">1</text></svg>`;
        else lBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>`;
    }

    function deletePlaylist() {
        if(currentPlaylistName && confirm("Delete this playlist?")) {
            ipcRenderer.invoke('delete-playlist', currentPlaylistName).then(async () => {
                await refreshLibrary();
                showHome();
            });
        }
    }

    function openMenu(e, song) {
        e.stopPropagation();
        selectedSong = song;
        const ctx = document.getElementById('ctx-playlists'); ctx.innerHTML = '';
        const rmBtn = document.getElementById('ctx-remove');
        if(currentPlaylistName) rmBtn.style.display = 'flex';
        else rmBtn.style.display = 'none';

        library.playlists.forEach(pl => {
            const d = document.createElement('div'); d.className = 'ctx-item'; d.innerText = decodeHtml(pl.name);
            d.onclick = () => { ipcRenderer.invoke('add-to-playlist', { playlistName: pl.name, song: selectedSong }); };
            ctx.appendChild(d);
        });
        const menu = document.getElementById('ctx-menu');
        menu.style.display = 'block'; menu.style.left = (e.pageX - 160) + 'px'; menu.style.top = e.pageY + 'px';
    }
    document.addEventListener('click', () => document.getElementById('ctx-menu').style.display = 'none');
    
    function removeFromPlaylist() {
        if(!currentPlaylistName) return;
        ipcRenderer.invoke('remove-from-playlist', { playlistName: currentPlaylistName, songId: selectedSong.id }).then(async () => {
            await refreshLibrary();
            showPlaylist(currentPlaylistName);
        });
    }

    function toggleLyrics() {
        const p = document.getElementById('lyrics-panel'); p.classList.toggle('show');
        document.getElementById('btn-lyrics').classList.toggle('active');
        document.body.style.gridTemplateColumns = p.classList.contains('show') ? "220px 1fr 350px" : "220px 1fr 0px";
    }
    const modal = document.getElementById('modal');
    function openModal() { modal.style.display = 'flex'; const inp = document.getElementById('pl-input'); inp.value = ""; inp.focus(); }
    function closeModal() { modal.style.display = 'none'; }
    function createPlaylist() {
        const n = document.getElementById('pl-input').value;
        if(n) ipcRenderer.invoke('create-playlist', n).then(async () => { 
            await refreshLibrary(); 
            closeModal(); 
        });
    }
    document.getElementById('pl-input').addEventListener('keypress', (e) => { if(e.key==='Enter') createPlaylist(); });

    function renderSidebar() {
        const div = document.getElementById('playlist-list'); div.innerHTML = '';
        library.playlists.forEach(pl => {
            const el = document.createElement('div'); el.className = 'playlist-item'; el.innerText = decodeHtml(pl.name);
            el.onclick = () => showPlaylist(pl.name); div.appendChild(el);
        });
    }

    audio.ontimeupdate = () => {
        if(audio.duration) {
            const pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('p-fill').style.width = pct + "%";
            document.getElementById('t-curr').innerText = fmt(audio.currentTime);
            document.getElementById('t-total').innerText = fmt(audio.duration);
        }
    }
    function seek(e) { if(audio.duration) audio.currentTime = (e.offsetX / document.getElementById('p-wrap').clientWidth) * audio.duration; }
    function fmt(s) { const m=Math.floor(s/60), sc=Math.floor(s%60); return `${m}:${sc<10?'0'+sc:sc}`; }

    document.body.style.gridTemplateColumns = "220px 1fr 0px";
  </script>
</body>
</html>